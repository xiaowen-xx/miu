<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<!-- 核心：viewport-fit=cover 让页面占满刘海 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<!-- 核心：沉浸式状态栏 -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#f5f5f5">

    
    <!-- 外部库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <!-- 引入样式文件 -->
     <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="phone-frame" id="phoneFrame">
        <!-- ... content ... -->
        <!-- 主屏幕 -->
        <div class="screen-content">
            <!-- Header -->
            <div class="bubble-image-wrapper" id="bubbleWrapper" onclick="showMenu(event, 'header')"><img src="https://placehold.co/360x300/transparent/ccc?text=Header+Image" id="headerImg" class="bubble-image"></div>
            
            <div class="profile-section">
                <img src="https://placehold.co/100x100/e0e0e0/333?text=A" alt="Avatar" class="avatar" id="avatarImg" onclick="showMenu(event, 'avatar')">
                <div class="info-card">
                    <div class="kaomoji" id="homeKaomoji" onclick="editText(this)">> ω <</div>
                    <div class="text-group">
                        <div class="handle editable-text" id="homeHandle" onclick="editText(this)">@Yueyuemiao77</div>
                        <div class="bio editable-text" id="homeBio" onclick="editText(this)">♫ ₊˚ 幸せのメロディー ✧ ⁺</div>
                        <div class="location" onclick="editLocation()"><i class="fas fa-map-marker-alt"></i> <span id="locationText">和鸟</span></div>
                    </div>
                </div>
            </div>
            
            <div class="section-title" id="widgetTitle" onclick="editText(this)">Widget Island</div>
            
            <!-- 分栏布局 -->
            <div class="main-layout-row">
                <!-- 左侧 -->
                <div class="kawaii-wrapper">
                    <div class="avatar-row">
                        <img src="https://placehold.co/100x100/eee/999?text=L" class="kawaii-avatar" id="kawaiiAvatarLeft" onclick="showMenu(event, 'kawaiiAvatarLeft')">
                        <img src="https://placehold.co/100x100/ddd/888?text=R" class="kawaii-avatar" id="kawaiiAvatarRight" onclick="showMenu(event, 'kawaiiAvatarRight')">
                    </div>
                    <div class="kawaii-card">
                        <div class="kawaii-text" id="kawaiiText" onclick="editText(this)">●ω● かわいい可愛.!!</div>
                        <div class="kawaii-white-box">
                            <div class="kawaii-time-row"><div class="k-time-text" id="realTimeDisplay">00:00</div></div>
                            <div class="k-date-text" id="realDateDisplay">2025-01-01</div>
                            <div class="k-icons-row">
                                <div class="k-icon-btn"><i class="fas fa-wifi"></i></div>
                                <div class="k-icon-btn"><i class="fas fa-broadcast-tower"></i></div>
                                <div class="k-icon-btn"><i class="fab fa-bluetooth-b bluetooth-icon"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="kawaii-bottom-text" id="kawaiiBottomText" onclick="editText(this)">《My Mood》</div>
                </div>

                <!-- 右侧 -->
                <div class="right-column">
                    <div class="right-apps-row">
                        <div class="mini-app-item">
                            <div class="mini-app-icon" id="app5IconWrapper"><img src="" style="display:none;" id="app5Img"><i class="fas fa-music" id="app5Default"></i></div>
                            <div class="mini-app-label">软件5</div>
                        </div>
                        <div class="mini-app-item">
                            <div class="mini-app-icon" id="app6IconWrapper"><img src="" style="display:none;" id="app6Img"><i class="fas fa-cloud" id="app6Default"></i></div>
                            <div class="mini-app-label">软件6</div>
                        </div>
                    </div>
                    <div class="camera-widget">
                        <div class="captcha-top"><div class="captcha-checkbox"></div><div class="captcha-label" id="captchaLabel" onclick="editText(this)">I'm not a robot</div></div>
                        <div class="captcha-body">
                            <div class="captcha-input-row"><div class="captcha-input" id="captchaInput" onclick="editText(this)">Type what u see</div><div class="captcha-verify-btn">Verify</div></div>
                            <div class="captcha-content-row">
                                <div class="captcha-img-container"><img src="https://placehold.co/150x80/white/333?text=Anime+Girl" class="captcha-img" id="captchaImg" onclick="showMenu(event, 'captcha')"></div>
                                <div class="captcha-icons-col"><i class="fas fa-sync-alt c-icon"></i><i class="fas fa-headphones c-icon"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 搜索栏 -->
            <div class="search-pill-container">
                <div class="search-pill"><i class="fas fa-search"></i> 搜索</div>
            </div>

        </div>
        
        <!-- Dock -->
        <div class="dock-capsule">
            <div class="dock-btn" onclick="openApp('Page 1')"><img id="dockIcon1" src="https://placehold.co/40/white/ccc?text=🤍" alt="Btn1"></div>
            <div class="dock-btn" onclick="openApp('Page 2')"><img id="dockIcon2" src="https://placehold.co/40/white/ccc?text=🍷" alt="Btn2"></div>
            <div class="dock-btn" onclick="openApp('Page 3')"><img id="dockIcon3" src="https://placehold.co/40/white/ccc?text=🐰" alt="Btn3"></div>
            <div class="dock-btn" onclick="openApp('Page 4')"><img id="dockIcon4" src="https://placehold.co/40/white/ccc?text=🐱" alt="Btn4"></div>
        </div>
        
        <div class="popover-menu" id="popMenu"><div class="menu-item" onclick="changeByLink()"><i class="fas fa-link"></i> 图片链接</div><div class="menu-item" onclick="triggerFileInput()"><i class="fas fa-image"></i> 本地图片</div></div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImportFile(this)">

         <!-- APP Overlay (WeChat) -->
        <div class="app-overlay" id="appOverlay">
            
            <div class="chat-container" id="chatAppPage">
                
                <!-- 消息页面 -->
                <div id="view-messages" class="tab-view active">
                    <header style="padding-top: 10px; padding-bottom: 5px; display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 100; background: transparent;">
                        <div class="app-title" style="font-size: 17px; font-weight: 600; color: #333;">WeChat</div>
                        <div class="plus-btn" onclick="togglePlusMenu(event)" style="position: absolute; right: 15px; font-size: 26px; font-weight: 300; cursor: pointer;">+</div>
                    </header>

                    <!-- 分组 Tab -->
                    <div class="group-card">
                        <div class="group-item active" onclick="selectGroup(this)">All</div>
                        <div class="group-item" onclick="selectGroup(this)">Friends</div>
                        <div class="group-item" onclick="selectGroup(this)">Groups</div>
                        <div class="group-item" onclick="selectGroup(this)">Others</div>
                    </div>

                    <!-- 列表容器 -->
                    <div id="chat-list-container"></div>
                </div>

                <div id="view-diary" class="tab-view"><div class="placeholder-page">日记页面暂无内容</div></div>
                <div id="view-moments" class="tab-view"><div class="placeholder-page">动态页面暂无内容</div></div>
                
                <!-- ★★★ "我的" 页面重写 (移植自 index15) ★★★ -->
                <div id="view-me" class="tab-view">
                    <!-- 1. 播放器卡片 -->
                    <div class="me-main-card">
                        <div class="music-area">
                            <div class="player-top">
                                <div class="player-avatar" onclick="showMenu(event, 'meAvatar')">
                                    <img id="meAvatarImg" src="https://placehold.co/100x100/pink/white?text=Me" alt="" style="display:block; width:100%; height:100%; object-fit:cover;">
                                </div>
                                <div class="player-info" onclick="toggleMusicPanel(true)">
                                    <div class="song-name" id="main-song-name">尚未播放</div>
                                    <div class="artist-name" id="main-artist-name">请点击这里选择音乐</div>
                                </div>
                            </div>
                            <div class="player-controls">
                                <div class="progress-container" id="progress-container">
                                    <div class="progress-bar-bg">
                                        <div class="progress-fill" id="progress-fill"></div>
                                        <div class="progress-dot" id="progress-dot"></div>
                                    </div>
                                </div>
                                <div class="control-btns" id="play-btn-root">
                                    <svg class="nav-btn-svg" style="transform: scaleX(-1);" viewBox="0 0 24 24" onclick="prevTrack()">
                                        <path d="M7 18l8.5-6L7 6v12zM17 6v12h2V6h-2z"/>
                                    </svg>
                                    <div class="play-btn-wrapper" onclick="togglePlayback()">
                                        <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <svg class="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                    </div>
                                    <svg class="nav-btn-svg" viewBox="0 0 24 24" onclick="nextTrack()">
                                        <path d="M7 18l8.5-6L7 6v12zM17 6v12h2V6h-2z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="doll-deco"></div>
                    </div>

                    <!-- 2. API 设置入口 -->
                    <div class="api-card" onclick="openApiSettings()">
                        <div class="icon-img icon-api"></div>API 设置
                    </div>
                    
                    <!-- 3. 设置列表 -->
                    <div class="settings-list">
                        <div class="setting-item" onclick="openWorldBookSettings()"><div class="icon-img icon-theme"></div>世界书</div>
                        <div class="setting-item" onclick="openBeautifyPage()"><div class="icon-img icon-theme"></div>美化主题</div>
                        <div class="setting-item" onclick="openFontSettings()"><div class="icon-img icon-theme"></div>字体</div>
                        <div class="setting-item" onclick="openGeneralSettings()"><div class="icon-img icon-theme"></div>设置</div>
                    </div>
                </div>
                
                <nav id="wechat-bottom-nav">
    <div class="nav-item active" onclick="switchAppTab(0)">
        <div class="nav-icon"></div>
        <span>Message</span>
    </div>
    <div class="nav-item" onclick="switchAppTab(1)">
        <div class="nav-icon"></div>
        <span>Diary</span>
    </div>
    <div class="nav-item" onclick="switchAppTab(2)">
        <div class="nav-icon"></div>
        <span>Moments</span>
    </div>
    <div class="nav-item" onclick="switchAppTab(3)">
        <div class="nav-icon"></div>
        <span>Me</span>
    </div>
</nav>

            <div class="generic-page" id="genericAppPage" style="display:none;"><h2 id="appTitle">APP NAME</h2></div>

            <div class="chat-room" id="chatRoom">
    <div class="folder-header-container">
        <div class="folder-tab">
            <div class="folder-back-btn" onclick="exitChatRoom()">&times;</div>
            <div class="folder-title" id="roomTitle">Name</div>
            <div class="folder-curve-connector"></div>
        </div>
        <div class="folder-right-space">
            <div class="folder-menu-btn" onclick="openChatSettings()">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </div>

    <div class="room-content" id="roomMessages"></div>
    
    <div class="msg-popover" id="msgPopover">
        <div class="msg-popover-item" onclick="handleRecallMsg()"><span style="font-size:14px;">撤回</span></div>
        <div class="msg-popover-arrow"></div>
    </div>

    <div class="room-footer" id="newRoomFooter">
        <div class="footer-btn-side" id="plusBtn" onclick="toggleChatTools(event)">
            <i class="fas fa-plus" id="plusIcon"></i>
        </div>
        <textarea class="msg-input" id="msgInput" placeholder="Aa" rows="1"></textarea>
        <div class="footer-btn-side send-btn" onclick="sendMsg()">
            <i class="fas fa-paper-plane"></i>
        </div>
    </div>
<div class="chat-tools-panel" id="chatToolsPanel">
    <div class="tools-grid" id="toolsMainMenu">
        <div class="tool-item" onclick="openStickerView()">
            <div class="tool-icon-box"><i class="far fa-laugh-squint"></i></div>
            <div class="tool-name">Emoji</div>
        </div>
        <div class="tool-item" onclick="startVoiceSimulation()">
            <div class="tool-icon-box"><i class="fas fa-microphone"></i></div>
            <div class="tool-name">Voice</div>
        </div>
    </div>

    <div class="sticker-panel" id="stickerSubView" style="display: none;">
        <div class="sticker-header">
            <div class="sticker-back-btn" onclick="backToToolsMenu()">
                <i class="fas fa-chevron-left"></i> 返回
            </div>
            <div class="sticker-title">My emoji</div>
            <div style="width:60px;"></div> 
        </div>
        <div class="sticker-grid" id="stickerGrid"></div>
    </div>

    <div class="sticker-panel" id="addStickerView" style="display: none;">
        <div class="sticker-header">
            <div class="sticker-back-btn" onclick="backToStickerList()">
                <i class="fas fa-chevron-left"></i> 返回
            </div>
            <div class="sticker-title">Emojis</div>
            <div style="width:60px;"></div>
        </div>
        <div style="padding: 10px 5px; display: flex; flex-direction: column; gap: 15px;">
            <input type="text" class="modal-input" id="newStickerName" placeholder="例如：开心转圈圈">
            <div class="edit-btns-row">
                <button class="edit-btn" onclick="handleAddSticker('link')">链接导入</button>
                <button class="edit-btn" onclick="handleAddSticker('local')">本地相册</button>
                <button class="edit-btn" style="background:#f0f0f0;color:#333;" onclick="handleBatchStickerImport()">批量导入</button>
            </div>
        </div>
    </div>
</div> <input type="file" id="stickerFileInput" accept="image/*" style="display: none;" onchange="handleStickerFile(this)">

<div id="voiceRecordMask" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.6); color:white; padding:30px; border-radius:20px; z-index:9999; flex-direction:column; align-items:center; gap:15px; backdrop-filter:blur(5px);">
    <i class="fas fa-microphone fa-3x" style="animation: pulse 1s infinite;"></i>
    <div id="recordTimer" style="font-family: monospace; font-size: 20px;">0:00</div>
    <div style="font-size:12px; opacity:0.8;">正在录音...</div>
  </div>   
</div><div class="chat-settings-page" id="chatSettingsPage">
    <div class="settings-header">
        <i class="fas fa-chevron-left settings-back-btn" onclick="closeChatSettings()"></i>
        <span>聊天设置</span>
    </div>  
                <div class="settings-content">
                    <div class="settings-profile-row">
                        <div class="settings-profile-col">
                            <div class="settings-real-name-display" id="settingsCharRealNameDisplay">真实姓名</div>
                            <img src="" class="settings-avatar" id="settingsCharAvatar" onclick="showMenu(event, 'settingsCharAvatar')">
                            <div class="settings-display-name" id="settingsCharName" onclick="editCharNameInSettings()">备注</div>
                        </div>
                        <div class="settings-profile-col">
                            <div class="settings-real-name-display" id="settingsUserRealNameDisplay">我的</div>
                            <img src="" class="settings-avatar" id="settingsUserAvatar" onclick="showMenu(event, 'settingsUserAvatar')">
                            <div class="settings-display-name" id="settingsUserName" onclick="editUserNameInSettings()">默认</div>
                        </div>
                    </div>
<div class="settings-card-box">
    <div class="settings-label">头像显示设置</div>
    
    <div class="settings-item">
        <span>显示对方头像</span>
        <!-- 修改了 onclick -->
        <div class="wb-toggle" id="toggleAiAvatar" onclick="toggleAvatarSwitch(this, 'ai')">
            <div class="wb-toggle-knob"></div>
        </div>
    </div>
    
    <div class="settings-item" style="border-bottom:none;">
        <span>显示我方头像</span>
        <!-- 修改了 onclick -->
        <div class="wb-toggle" id="toggleUserAvatar" onclick="toggleAvatarSwitch(this, 'user')">
            <div class="wb-toggle-knob"></div>
        </div>
    </div>
</div>
                    <!-- [合并修改] 角色设定卡片 -->
                    <div class="settings-card-box">
                        <div class="settings-label">对方人设</div>
                        <textarea class="settings-textarea" id="charPersona" placeholder="请输入对方人设..."></textarea>
                        
                        <div class="settings-spacer"></div>

                        <div class="settings-label">我方人设</div>
                        <textarea class="settings-textarea" id="userPersona" placeholder="请输入我方人设..."></textarea>
                    </div>

                    <div class="settings-card-box">
                        <div class="settings-label">记忆与总结设置</div>

                        <!-- 1. 总结指令 (占位符修改) -->
                        <textarea class="settings-textarea" id="chatMemory" placeholder="总结指令..." style="margin-bottom: 15px; height:60px; min-height:60px;"></textarea>
                        
                        <!-- 2. 携带条数 (右对齐) -->
                        <div class="mem-row">
                            <span style="font-size:13px;color:#666;">携带上下文条数</span>
                            <input type="number" class="mem-input-small" id="memContextLimit" value="50" placeholder="50">
                        </div>

                        <!-- 3. 阈值设定 (右对齐) -->
                        <div class="mem-row">
                            <span style="font-size:13px;color:#666;">总结触发阈值</span>
                            <input type="number" class="mem-input-small" id="memThreshold" value="50" placeholder="50">
                        </div>

                        <!-- 4. 总结模式开关 (参考图片样式) -->
                        <div class="mem-row">
                            <span style="font-size:13px;color:#666;">总结模式</span>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <!-- 文字状态：手动(蓝色)/自动(绿色) -->
                                <span id="memModeText" style="font-size:14px; color:#007aff; font-weight:500;">手动</span>
                                <!-- 开关组件 -->
                                <div class="wb-toggle" id="memAutoToggle" onclick="toggleMemMode()">
                                    <div class="wb-toggle-knob"></div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-spacer"></div>

                        <!-- 5. 立即执行总结 (纯白立体按钮) -->
                        <div class="settings-label" style="font-size:12px;color:#999;margin-bottom:5px;">手动执行</div>
                        <div class="mem-row" style="margin-bottom:5px;">
                            <span style="font-size:12px;color:#ccc;">范围:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" class="mem-input-small" id="summaryStart" placeholder="1" style="width:50px;">
                                <span style="font-size:12px;color:#ccc;">-</span>
                                <input type="number" class="mem-input-small" id="summaryEnd" placeholder="End" style="width:50px;">
                            </div>
                        </div>
                        <div class="plump-btn" onclick="triggerRangeSummary()">
                            <i class="fas fa-magic"></i> 立即执行总结
                        </div>

                        <div class="settings-spacer"></div>
                        <div style="border-top: 1px dashed #eee; margin: 5px 0 10px 0;"></div>

                        <!-- 6. 总结记忆库 (点击标题展开/收起) -->
                        <div class="mem-bank-header" id="memBankHeader" onclick="toggleBankList()">
                            <span class="settings-label" style="font-size:12px;color:#999; margin:0;">总结记忆库 (Summaries)</span>
                            <i class="fas fa-chevron-right mem-bank-arrow" id="memBankArrow"></i>
                        </div>
                        
                        <!-- 展开后的容器 -->
                        <div id="memSummaryContainer">
                            <div id="memSummaryList">
                                <!-- JS 插入卡片 -->
                            </div>
                        </div>

                        <!-- 7. 统计栏 (保持原样不动) -->
                        <div class="mem-stats-bar">
                            <div class="mem-stat-item"><i class="fas fa-comment-dots"></i> 消息: <span id="statMsgCount">0</span></div>
                            <div class="mem-stat-item"><i class="fas fa-coins"></i> Tokens: <span id="statTokenCount">0</span></div>
                        </div>
                    </div>
                    <div class="settings-card-box">
                        <div class="settings-label" style="margin-bottom:10px;">Miu气泡美化(CSS)</div>

                        <!-- 1. 快速配色 (工具栏) -->
                        <div style="font-size:11px;color:#ccc;margin-bottom:5px;">点击应用配色模板：</div>
                        <div class="color-selector-wrapper" id="colorGrid">
                            <!-- JS 自动生成圆圈 -->
                        </div>

                        <!-- 2. 代码编辑区 -->
                        <textarea class="settings-textarea code-font" id="customCssInput" placeholder="在此粘贴或编辑 CSS 代码..." oninput="updateBubblePreview()"></textarea>

                    <!-- 3. 实时预览区 (位置修正版) -->
                        <div class="bubble-preview-container" id="bubblePreviewArea">
                            <div class="img-preview-wrapper">
                                <!-- 背景图 -->
                                <img src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/12/e429569cf8d34859825286132afff77a.png" class="img-preview-bg">
                                
                                <!-- 左侧贴图 (对方) -->
                                <div class="preview-overlay-box preview-pos-left">
                                    <div class="Miu-miu ai">
                                        <!-- 对方头像 ID -->
                                        <img src="" class="avatar-img" id="previewRealAvatar">
                                        <div class="content">모든 일이 순조롭다</div>
                                    </div>
                                </div>

                                <!-- 右侧贴图 (我方) -->
                                <div class="preview-overlay-box preview-pos-right">
                                    <div class="Miu-miu user">
                                        <div class="content">say u love me 2</div>
                                        <!-- ★★★ [新增] 我方头像 ID，放在这里以显示在右边 ★★★ -->
                                        <img src="" class="avatar-img" id="previewUserAvatar">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. 预设管理 (折叠在底部) -->
                        <div class="preset-manager-toggle" onclick="togglePresetManager()">
                            <span><i class="fas fa-folder"></i> 管理我的气泡预设</span>
                            <i class="fas fa-chevron-down" id="presetArrow"></i>
                        </div>
                        
                        <div class="preset-manager-body" id="presetManagerBody">
                            <div class="preset-select-row">
                                <select id="cssPresetDropdown" onchange="loadSelectedPreset()">
                                    <option value="">-- 选择已保存的预设 --</option>
                                </select>
                            </div>
                            <div class="preset-btn-row">
                                <button class="preset-btn btn-save-new" onclick="saveNewPreset()">新建保存</button>
                                <button class="preset-btn btn-update" onclick="updateCurrentPreset()">覆盖更新</button>
                                <button class="preset-btn btn-delete" onclick="deleteCurrentPreset()">删除</button>
                            </div>
                            <div style="font-size:10px;color:#999;margin-top:5px;text-align:center;">
                                * 保存将会存储上方输入框中的当前代码
                            </div>
                        </div>

                        <div class="save-float-btn" onclick="saveCurrentChatSettings()">保存所有设置</div>
                    </div> 
                </div> 
            </div> 
            
            <div class="api-settings-page" id="apiSettingsPage">

                <div class="api-header"><i class="fas fa-chevron-left api-back-btn" onclick="closeApiSettings()"></i><span class="api-title">API 配置</span><div style="width:40px"></div></div>
                <div class="api-content">
                    <div class="api-input-group"><label>API Endpoint</label><input type="text" class="api-input" id="apiEndpoint" value="https://api2.qiandao.mom/v1" readonly style="background-color: #f5f5f5; color: #888;"></div>
                    <div class="api-input-group"><div style="display:flex; justify-content:space-between; align-items:center;"><label>API Key</label><a href="https://api2.qiandao.mom" target="_blank" style="font-size:11px; color:#999; text-decoration: underline; text-decoration-color: #999;">注册站点/充值额度</a></div><input type="password" class="api-input" id="apiKey" placeholder="sk-..."></div>
                    <div class="api-input-group"><label>Model</label><div class="api-row-flex"><select class="api-input" id="apiModel"><option value="gpt-3.5-turbo">gpt-3.5-turbo</option><option value="gpt-4">gpt-4</option></select><button class="api-btn-small" onclick="fetchModels()">拉取</button></div></div><div class="api-input-group"><div class="flex-between"><label>Temperature</label><span id="tempDisplay">1.0</span></div><input type="range" id="apiTemp" min="0" max="2" step="0.1" value="1.0" oninput="document.getElementById('tempDisplay').innerText = this.value"></div><div class="api-divider"></div><div class="api-input-group"><label>保存配置方案</label><div class="api-row-flex"><input type="text" class="api-input" id="configName" placeholder="方案名称"><button class="api-btn-small" onclick="saveCurrentConfig()">保存</button></div></div><div class="config-list" id="configList"></div></div></div>
            
            <!-- Font Settings (Fix: Moved out) -->
            <div class="api-settings-page" id="fontSettingsPage">
                <div class="api-header">
                    <i class="fas fa-chevron-left api-back-btn" onclick="closeFontSettings()"></i>
                    <span class="api-title">全局字体</span>
                    <div style="width:40px"></div>
                </div>
                <div class="api-content">
                    <div class="api-input-group">
                        <label>字体预览</label>
                        <div class="font-preview-box" id="fontPreviewBox">
                            <div class="font-text-cn">跟你聊天很开心，被你老公打死也值了</div>
                            <div class="font-text-en">Miu Phone is really fun, so fun</div>
                        </div>
                    </div>

                    <div class="api-input-group">
                        <label>设置新字体</label>
                        <div class="edit-btns-row">
                            <button class="edit-btn" onclick="setFontByLink()">链接导入 (URL)</button>
                            <button class="edit-btn" onclick="document.getElementById('fontFileInput').click()">本地文件导入 (TTF/WOFF)</button>
                            <button class="edit-btn" style="color:red" onclick="resetDefaultFont()">恢复默认</button>
                        </div>
                        <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="handleFontFile(this)">
                    </div>

                    <div class="api-divider" style="height:1px; background:#eee; margin:10px 0;"></div>

                    <div class="api-input-group">
                        <label>保存当前字体为方案</label>
                        <div class="api-row-flex">
                            <input type="text" class="api-input" id="fontSchemeName" placeholder="方案名称 (例如: 圆圆的字体)">
                            <button class="api-btn-small" onclick="saveFontScheme()">保存</button>
                        </div>
                    </div>

                    <div class="api-input-group">
                        <label>已保存的字体方案</label>
                        <div id="fontSchemeList" style="margin-top:5px;"></div>
                    </div>
                </div>
            </div>

            <!-- General Settings (Fix: Moved out) -->
            <div class="api-settings-page" id="generalSettingsPage">
                <div class="api-header"><i class="fas fa-chevron-left api-back-btn" onclick="closeGeneralSettings()"></i><span class="api-title">设置</span><div style="width:40px"></div></div>
                <div class="api-content">
                    <div class="api-input-group"><label>数据备份与恢复</label><button class="api-save-btn" onclick="exportBackup()"><i class="fas fa-file-export"></i> 导出备份 (JSON)</button><button class="api-save-btn" style="background:#fff; color:#000; border:1px solid #ddd;" onclick="document.getElementById('importInput').click()"><i class="fas fa-file-import"></i> 恢复备份</button></div>
                </div>
            </div>

            <!-- World Book Settings Page (REDESIGN) -->
            <div class="wb-settings-page" id="worldBookSettingsPage">
                <div class="wb-main-header">
                    <i class="fas fa-chevron-left" style="font-size:20px;cursor:pointer;" onclick="closeWorldBookSettings()"></i>
                    <div class="wb-main-title">世界书</div>
                    <div class="wb-add-icon" id="wbHeaderBtn" onclick="toggleWbMenu(event)"><i class="fas fa-plus"></i></div>
                </div>
                
                <div class="wb-popover" id="wbPopMenu">
                    <div class="wb-pop-item" onclick="openCreateWBModal()">创建世界书</div>
                    <div class="wb-pop-item" onclick="toggleWbManageMode()">管理世界书</div>
                    <div class="wb-pop-item" onclick="alert('导入世界书(功能待开发)')">导入世界书</div>
                </div>

                <div class="wb-filter-section">
                    <div class="wb-filter-card">
                        <div class="wb-filter-label">列表筛选：</div>
                        <div class="wb-filter-trigger" onclick="openWbFilterSheet()">
                            <span id="wbFilterText">全部类型</span> <i class="fas fa-chevron-down" style="color:#999;font-size:12px;"></i>
                        </div>
                    </div>
                </div>

                <div class="wb-content-area" id="wbContentArea"></div>
            </div>

            <!-- Filter Bottom Sheet (Action Sheet) -->
            <div class="sheet-overlay" id="wbFilterOverlay" onclick="closeWbFilterSheet()">
                <div class="bottom-sheet" onclick="event.stopPropagation()">
                    <div class="sheet-header">选择筛选类型</div>
                    <div class="sheet-option selected" onclick="selectWbFilter('all', this)">全部类型</div>
                    <div class="sheet-option" onclick="selectWbFilter('always', this)">始终触发</div>
                    <div class="sheet-option" onclick="selectWbFilter('keyword', this)">关键词触发</div>
                    <div class="sheet-option sheet-cancel" onclick="closeWbFilterSheet()">取消</div>
                </div>
            </div>

            <!-- Create WB Modal (Fixed Layout with Textarea) -->
            <div class="wb-create-modal" id="wbCreateModal">
                <div class="wb-create-card">
                    <div class="wb-create-title">新建世界书</div>
                    
                    <div class="wb-field">
                        <label class="wb-field-label">世界书名称</label>
                        <input type="text" class="wb-field-input" id="wbCreateName" placeholder="输入名称...">
                    </div>
                    
                    <div class="wb-field">
                        <div class="wb-row-space">
                            <label class="wb-field-label">分组</label>
                            <span class="wb-manage-link" onclick="openGroupManager()">管理</span>
                        </div>
                        <select class="wb-field-input" id="wbCreateGroup"></select>
                    </div>

                    <div class="wb-field">
                        <div class="wb-row-space">
                            <label class="wb-field-label">角色世界书</label>
                            <div class="wb-toggle" id="wbCharToggle" onclick="toggleSwitch(this); checkCharBind()">
                                <div class="wb-toggle-knob"></div>
                            </div>
                        </div>
                        <div id="wbBindCharDiv" style="display:none; margin-top:5px;">
                            <span class="wb-sub-btn" onclick="openCharBinder()">+ 绑定角色: <span id="wbBoundCharName">无</span></span>
                        </div>
                    </div>
                    
                    <div class="wb-field">
                        <label class="wb-field-label">触发类型</label>
                        <select class="wb-field-input" id="wbTriggerType" onchange="checkKeywords()">
                            <option value="always">始终触发</option>
                            <option value="keyword">关键词触发</option>
                        </select>
                    </div>

                    <div class="wb-field" id="wbKeywordField" style="display:none;">
                        <label class="wb-field-label">关键词 (用英文逗号分隔)</label>
                        <input type="text" class="wb-field-input" id="wbCreateKeywords" placeholder="key1,key2...">
                    </div>

                    <div class="wb-field">
                        <label class="wb-field-label">内容条目</label>
                        <div class="wb-entries-list" id="wbEntriesList"></div>
                        <div class="wb-entry-add-btn" onclick="addEntryRow()">+ 新建条目</div>
                    </div>

                    <div class="wb-save-btn" onclick="saveWorldBook()">完成</div>
                    <div class="wb-cancel-btn" onclick="closeCreateWBModal()">取消</div>
                </div>
            </div>

            <!-- Group Manager Overlay -->
            <div class="wb-mini-overlay" id="wbGroupOverlay">
                <div class="wb-mini-box">
                    <h3 style="text-align:center;font-size:16px;">管理分组</h3>
                    <div class="wb-mini-list" id="wbGroupList"></div>
                    <div style="display:flex;gap:5px;">
                        <input type="text" id="wbNewGroupInput" style="flex:1;padding:8px;border:1px solid #eee;border-radius:8px;" placeholder="新分组名">
                        <button onclick="addGroup()" style="padding:8px;background:#000;color:#fff;border-radius:8px;">添加</button>
                    </div>
                    <button onclick="closeGroupManager()" style="width:100%;padding:10px;background:#f5f5f5;border-radius:8px;">关闭</button>
                </div>
            </div>

            <!-- Char Binder Overlay -->
            <div class="wb-mini-overlay" id="wbCharOverlay">
                <div class="wb-mini-box">
                    <h3 style="text-align:center;font-size:16px;">选择角色</h3>
                    <div class="wb-mini-list" id="wbCharList"></div>
                    <button onclick="closeCharBinder()" style="width:100%;padding:10px;background:#f5f5f5;border-radius:8px;">取消</button>
                </div>
            </div>

            <!-- Beautify Page (Fix: Layout Update) -->
<div class="api-settings-page" id="beautifyPage">
    <div class="api-header">
        <i class="fas fa-chevron-left api-back-btn" onclick="closeBeautifyPage()"></i>
        <span class="api-title">美化中心</span>
        <div style="width:40px"></div>
    </div>
    
    <div class="api-content">
        
        <!-- 1. Dock 设置区 -->
        <div class="settings-label" style="margin-bottom:10px; margin-left:5px;">Dock栏样式</div>
        
        <!-- Dock 预览 -->
        <div class="dock-preview-wrapper">
            <div class="dock-preview">
                <div class="dock-btn"><img id="previewDock1" src=""></div>
                <div class="dock-btn"><img id="previewDock2" src=""></div>
                <div class="dock-btn"><img id="previewDock3" src=""></div>
                <div class="dock-btn"><img id="previewDock4" src=""></div>
            </div>
        </div>
        
        <!-- Dock 图标设置网格 -->
        <div class="edit-grid">
            <div class="edit-card">
                <div class="edit-card-title">WeChat</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeDockIcon(1, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeDockIcon(1, 'local')">相册</button>
                </div>
            </div>
            <div class="edit-card">
                <div class="edit-card-title">应用 2</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeDockIcon(2, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeDockIcon(2, 'local')">相册</button>
                </div>
            </div>
            <div class="edit-card">
                <div class="edit-card-title">应用 3</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeDockIcon(3, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeDockIcon(3, 'local')">相册</button>
                </div>
            </div>
            <div class="edit-card">
                <div class="edit-card-title">应用 4</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeDockIcon(4, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeDockIcon(4, 'local')">相册</button>
                </div>
            </div>
        </div>

        <div class="api-divider" style="height:1px; background:#f0f0f0; margin: 10px 0 20px 0;"></div>

        <!-- 2. 桌面APP图标区 -->
        <div class="settings-label" style="margin-bottom:10px; margin-left:5px;">桌面APP图标</div>
        
        <div class="app-preview-wrapper">
            <div class="app-preview-icon"><img id="previewApp5" src="" style="display:none;"><i class="fas fa-music" id="previewApp5Default"></i></div>
            <div class="app-preview-icon"><img id="previewApp6" src="" style="display:none;"><i class="fas fa-cloud" id="previewApp6Default"></i></div>
        </div>

        <div class="edit-grid">
            <div class="edit-card">
                <div class="edit-card-title">软件 5</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeAppIcon(5, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeAppIcon(5, 'local')">相册</button>
                </div>
            </div>
            <div class="edit-card">
                <div class="edit-card-title">软件 6</div>
                <div class="edit-btns-row">
                    <button class="edit-btn" onclick="changeAppIcon(6, 'link')">链接</button>
                    <button class="edit-btn" onclick="changeAppIcon(6, 'local')">相册</button>
                </div>
            </div>
        </div>

        <div class="api-divider" style="height:1px; background:#f0f0f0; margin: 10px 0 20px 0;"></div>

        <!-- 3. 壁纸设置区 (图7样式) -->
        <div class="settings-label" style="margin-bottom:10px; margin-left:5px;">全局壁纸管理</div>

        <!-- 主屏壁纸 -->
        <div class="edit-card" style="margin-bottom: 20px; width: 100%;">
            <div class="edit-card-title">主屏幕壁纸</div>
            <div class="wallpaper-preview-box" id="wallpaperPreviewBox" style="width:100px; height:180px; margin: 0 auto 15px auto; border: 2px solid #eee; border-radius: 10px; overflow:hidden; background:#f9f9f9; display:flex; align-items:center; justify-content:center;">
                <!-- [补全] 缺失的占位符 div -->
                <div id="wallpaperPlaceholder" style="color:#ccc; font-size:12px;">默认</div>
                <img id="wallpaperPreviewImg" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
            <div class="edit-btns-row">
                <button class="edit-btn" onclick="changeWallpaper('link')">链接导入</button>
                <button class="edit-btn" onclick="changeWallpaper('local')">本地相册</button>
                <button class="edit-btn" style="color:#ff3b30; background:#fff0f0;" onclick="clearWallpaper()">清除</button>
            </div>
        </div>

        <!-- WeChat壁纸 -->
        <div class="edit-card" style="margin-bottom: 20px; width: 100%;">
            <div class="edit-card-title">WeChat 壁纸</div>
            <div class="wallpaper-preview-box" id="wcWallpaperPreviewBox" style="width:100px; height:180px; margin: 0 auto 15px auto; border: 2px solid #eee; border-radius: 10px; overflow:hidden; background:#f9f9f9; display:flex; align-items:center; justify-content:center;">
                <!-- [补全] 缺失的占位符 div -->
                <div id="wcWallpaperPlaceholder" style="color:#ccc; font-size:12px;">默认</div>
                <img id="wcWallpaperPreviewImg" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
            <div class="edit-btns-row">
                <button class="edit-btn" onclick="changeWallpaper('wechat_link')">链接导入</button>
                <button class="edit-btn" onclick="changeWallpaper('wechat_local')">本地相册</button>
                <button class="edit-btn" style="color:#ff3b30; background:#fff0f0;" onclick="clearWechatWallpaper()">清除</button>
            </div>
        </div>
        <!-- 聊天页壁纸 -->
        <div class="edit-card" style="margin-bottom: 20px; width: 100%;">
            <div class="edit-card-title">聊天页壁纸</div>
            <div class="wallpaper-preview-box" id="chatRoomWallpaperPreviewBox">
                <div id="chatRoomWallpaperPlaceholder" style="color:#ccc; font-size:12px;">默认</div>
                <img id="chatRoomWallpaperPreviewImg" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
            <div class="edit-btns-row">
                <button class="edit-btn" onclick="changeWallpaper('chatroom_link')">链接导入</button>
                <button class="edit-btn" onclick="changeWallpaper('chatroom_local')">本地相册</button>
                <button class="edit-btn" style="color:#ff3b30; background:#fff0f0;" onclick="clearChatRoomWallpaper()">清除</button>
            </div>
        </div>

    </div> </div> </div> <div class="modal-overlay" id="addCharModal">
    <div class="modal-box">
        <div class="modal-title">创建新角色</div>
        <img src="https://placehold.co/100/e0e0e0/888?text=+" class="modal-avatar" id="newCharAvatar" onclick="showMenu(event, 'newCharAvatar')">
        <div class="modal-avatar-hint">点击更换头像</div>
        <div class="modal-input-group"><label class="modal-label">真实姓名</label><input type="text" class="modal-input" id="newCharRealName" placeholder="例如：林晚晚"></div>
        <div class="modal-input-group"><label class="modal-label">备注 / 显示名</label><input type="text" class="modal-input" id="newCharName" placeholder="例如：晚晚"></div>
        <div class="modal-input-group"><label class="modal-label">人物设定</label><textarea class="modal-input" id="newCharSetting" placeholder="写点什么设定..."></textarea></div>
        <div class="modal-input-group">
            <label class="modal-label">绑定世界书</label>
            <div class="world-book-selector" id="wbSelector" onclick="openWorldBookModal()"><span id="wbSelectedText">点击选择世界书...</span><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel-modal" onclick="closeAddCharModal()">取消</button>
            <button class="modal-btn btn-confirm-modal" onclick="confirmAddChar()">确认添加</button>
        </div>
    </div>
</div>

<div class="wb-modal-overlay" id="wbModal">
    <div class="wb-modal-box">
        <div class="wb-header">选择世界书</div>
        <div id="wbList" class="wb-list"></div>
        <div class="wb-confirm-btn" onclick="confirmWorldBooks()">完成</div>
    </div>
</div>

<div class="chat-dropdown" id="plusMenu">
    <div class="chat-dropdown-item" onclick="openAddCharModal()"><i class="fas fa-user"></i> 单人聊天</div>
    <div class="chat-dropdown-item" onclick="alert('多人聊天')"><i class="fas fa-users"></i> 多人聊天</div>
    <div class="chat-dropdown-item" onclick="alert('导入角色')"><i class="fas fa-file-import"></i> 导入角色</div>
</div>

<div class="modal-overlay" id="voiceInputModal" style="z-index: 5000;">
    <div class="modal-box">
        <div class="modal-title">Voice</div>
        <div class="modal-input-group">
            <label class="modal-label">输入你想说的内容</label>
            <textarea class="modal-input" id="voiceTextContent" placeholder="在此输入文字..."></textarea>
        </div>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel-modal" onclick="closeVoiceModal()">取消</button>
            <button class="modal-btn btn-confirm-modal" onclick="confirmSendVoice()">发送语音</button>
        </div>
    </div>
</div>

    <!-- ★★★ 音乐面板覆盖层 ★★★ -->
    <div id="music-panel-overlay" onclick="toggleMusicPanel(false)"></div>
    
    <div id="music-panel">
        <!-- 1. 新增：面板顶部标题栏 -->
<div class="panel-header" style="position: relative;"> <!-- 增加 relative 定位 -->
    <div class="panel-title">播放列表</div>
    <!-- 修改 onclick 事件 -->
    <div class="panel-plus" onclick="toggleMusicPlusMenu(event)">+</div>
    
    <!-- ★★★ 新增：直接显示的小菜单 ★★★ -->
    <div class="music-plus-dropdown" id="musicPlusMenu">
        <div class="mp-item" onclick="triggerMusicFile()">本地音乐</div>
        <div class="mp-line"></div>
        <div class="mp-item" onclick="triggerMusicLink()">网络链接</div>
    </div>
</div>

        <!-- 2. 音乐列表容器 -->
        <div class="music-list-scroll" id="music-list-container">
            <!-- JS 渲染内容 -->
        </div>
    </div>


    
    <!-- ★★★ 隐藏的文件输入框 (用于选择本地音乐) ★★★ -->
    <input type="file" id="musicFileInput" accept="audio/*" style="display: none;" onchange="handleMusicFile(event)">
    <!-- 脚本引用 -->
    <script src="script.js"></script>
</body>
</html>